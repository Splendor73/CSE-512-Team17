============================= test session starts ==============================
platform darwin -- Python 3.11.14, pytest-7.4.3, pluggy-1.6.0
rootdir: /Users/yashupatel/ASU Dropbox/Yashu Patel/ASU/512/GP_code
plugins: Faker-20.1.0, asyncio-0.21.1, anyio-3.7.1
asyncio: mode=Mode.STRICT
collected 4 items

tests/test_queries.py DEBUG: Fetching from http://localhost:8001
DEBUG: Response from http://localhost:8001: 200
DEBUG: Data from http://localhost:8001: [{'rideId': 'R-1', 'vehicleId': 'AV-1', 'customerId': 'C-1', 'status': 'COMPLETED', 'city': 'Phoenix', 'fare': 20.0, 'startLocation': {'lat': 0, 'lon': 0}, 'currentLocation': {'lat': 0, 'lon': 0}, 'endLocation': {'lat': 0, 'lon': 0}, 'timestamp': '2024-12-02T10:00:00Z'}]
..DEBUG: Starting global live search. Regions: {'Phoenix': 'http://localhost:8001', 'Los Angeles': 'http://localhost:8002'}
DEBUG: Fetching from http://localhost:8001
DEBUG: Response from http://localhost:8001: 200
DEBUG: Data from http://localhost:8001: [{'rideId': 'R-PHX', 'vehicleId': 'AV-1', 'customerId': 'C-1', 'status': 'COMPLETED', 'city': 'Phoenix', 'fare': 20.0, 'startLocation': {'lat': 0, 'lon': 0}, 'currentLocation': {'lat': 0, 'lon': 0}, 'endLocation': {'lat': 0, 'lon': 0}, 'timestamp': '2024-12-02T10:00:00Z'}]
DEBUG: Fetching from http://localhost:8002
DEBUG: Response from http://localhost:8002: 200
DEBUG: Data from http://localhost:8002: [{'rideId': 'R-LA', 'vehicleId': 'AV-2', 'customerId': 'C-2', 'status': 'COMPLETED', 'city': 'Los Angeles', 'fare': 25.0, 'startLocation': {'lat': 0, 'lon': 0}, 'currentLocation': {'lat': 0, 'lon': 0}, 'endLocation': {'lat': 0, 'lon': 0}, 'timestamp': '2024-12-02T11:00:00Z'}]
DEBUG: Gather results: [1 validation error for RideResponse
rideId
  String should match pattern '^R-\d+$' [type=string_pattern_mismatch, input_value='R-PHX', input_type=str]
    For further information visit https://errors.pydantic.dev/2.5/v/string_pattern_mismatch, 1 validation error for RideResponse
rideId
  String should match pattern '^R-\d+$' [type=string_pattern_mismatch, input_value='R-LA', input_type=str]
    For further information visit https://errors.pydantic.dev/2.5/v/string_pattern_mismatch]
DEBUG: Result is not a list: 1 validation error for RideResponse
rideId
  String should match pattern '^R-\d+$' [type=string_pattern_mismatch, input_value='R-PHX', input_type=str]
    For further information visit https://errors.pydantic.dev/2.5/v/string_pattern_mismatch
DEBUG: Result is not a list: 1 validation error for RideResponse
rideId
  String should match pattern '^R-\d+$' [type=string_pattern_mismatch, input_value='R-LA', input_type=str]
    For further information visit https://errors.pydantic.dev/2.5/v/string_pattern_mismatch
F.

=================================== FAILURES ===================================
___________________ TestQueryRouter.test_search_global_live ____________________

self = <tests.test_queries.TestQueryRouter object at 0x109403290>
mock_http = <AsyncMock name='http_client' id='4451107536'>

    @patch("services.coordinator.http_client", new_callable=AsyncMock)
    async def test_search_global_live(self, mock_http):
        """Test global-live scope (scatter-gather)"""
        router = QueryRouter()
        query = RideQuery(scope="global-live", limit=10)
    
        # Mock responses for Phoenix and LA
        # We need to mock separate calls for different URLs
    
        async def side_effect(url, params=None, timeout=None):
            mock_resp = MagicMock()
            mock_resp.status_code = 200
            if "8001" in url: # Phoenix
                mock_resp.json.return_value = [{
                    "rideId": "R-PHX",
                    "vehicleId": "AV-1",
                    "customerId": "C-1",
                    "status": "COMPLETED",
                    "city": "Phoenix",
                    "fare": 20.0,
                    "startLocation": {"lat": 0, "lon": 0},
                    "currentLocation": {"lat": 0, "lon": 0},
                    "endLocation": {"lat": 0, "lon": 0},
                    "timestamp": "2024-12-02T10:00:00Z"
                }]
            else: # LA
                mock_resp.json.return_value = [{
                    "rideId": "R-LA",
                    "vehicleId": "AV-2",
                    "customerId": "C-2",
                    "status": "COMPLETED",
                    "city": "Los Angeles",
                    "fare": 25.0,
                    "startLocation": {"lat": 0, "lon": 0},
                    "currentLocation": {"lat": 0, "lon": 0},
                    "endLocation": {"lat": 0, "lon": 0},
                    "timestamp": "2024-12-02T11:00:00Z" # Later timestamp
                }]
            return mock_resp
    
        mock_http.get.side_effect = side_effect
    
        results = await router.search(query)
    
        # Should have 2 results
>       assert len(results) == 2
E       assert 0 == 2
E        +  where 0 = len([])

tests/test_queries.py:126: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  services.coordinator:coordinator.py:460 Scatter query failed for one region: 1 validation error for RideResponse
rideId
  String should match pattern '^R-\d+$' [type=string_pattern_mismatch, input_value='R-PHX', input_type=str]
    For further information visit https://errors.pydantic.dev/2.5/v/string_pattern_mismatch
WARNING  services.coordinator:coordinator.py:460 Scatter query failed for one region: 1 validation error for RideResponse
rideId
  String should match pattern '^R-\d+$' [type=string_pattern_mismatch, input_value='R-LA', input_type=str]
    For further information visit https://errors.pydantic.dev/2.5/v/string_pattern_mismatch
=============================== warnings summary ===============================
../../../../../miniconda3/envs/cse512/lib/python3.11/site-packages/pydantic/_internal/_config.py:268: 14 warnings
  /Users/yashupatel/miniconda3/envs/cse512/lib/python3.11/site-packages/pydantic/_internal/_config.py:268: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

services/models.py:47
  /Users/yashupatel/ASU Dropbox/Yashu Patel/ASU/512/GP_code/services/models.py:47: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator("fare")

services/models.py:82
  /Users/yashupatel/ASU Dropbox/Yashu Patel/ASU/512/GP_code/services/models.py:82: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator("fare")

services/models.py:270
  /Users/yashupatel/ASU Dropbox/Yashu Patel/ASU/512/GP_code/services/models.py:270: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.5/migration/
    @validator("target")

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_queries.py::TestQueryRouter::test_search_global_live - asse...
=================== 1 failed, 3 passed, 17 warnings in 0.51s ===================
